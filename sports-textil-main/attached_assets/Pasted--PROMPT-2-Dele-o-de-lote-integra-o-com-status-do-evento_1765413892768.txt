"
---

## üß± PROMPT 2 ‚Äì Dele√ß√£o de lote + integra√ß√£o com status do evento (expirado/publicado)

```text
Contexto
--------
Temos mais dois problemas relacionados a lotes e ao status do evento na tela do cliente:

1. A fun√ß√£o de deletar lote **n√£o est√° funcionando**:
   - Precisa funcionar, mas com seguran√ßa:
     - Se houver pedidos/inscri√ß√µes vinculados ao lote, ele N√ÉO pode ser deletado.

2. O status do evento na tela do cliente:
   - Est√° sendo marcado como ""expirado"" quando n√£o h√° lote v√°lido ‚Üí isso est√° OK.
   - Por√©m, o inverso n√£o est√° funcionando:
     - Ativar um lote n√£o altera o status do evento
     - E ao publicar o evento, ele volta a ficar ""expirado"" porque a l√≥gica depende do status dos lotes.

3. N√£o √© seguro ""publicar automaticamente"" o evento ao ativar um lote, mas:
   - Quando o evento est√° expirado e o admin ativa um lote, seria interessante:
     - PERGUNTAR ao admin se ele quer publicar o evento agora
     - e s√≥ mudar o status do evento se ele confirmar.


Parte 1 ‚Äì Dele√ß√£o de lote com seguran√ßa
---------------------------------------

Quero que:

1. A fun√ß√£o de deletar lote seja implementada corretamente, com as seguintes regras:

   - Se o lote N√ÉO tiver nenhuma inscri√ß√£o/pedido associado:
     - permitir deletar normalmente
   - Se o lote tiver inscri√ß√µes/pedidos:
     - bloquear exclus√£o
     - retornar erro claro:
       - c√≥digo: `BATCH_HAS_REGISTRATIONS`
       - mensagem: ""Este lote possui inscri√ß√µes vinculadas e n√£o pode ser apagado.""

2. No frontend/admin:
   - Ao tentar excluir um lote:
     - Exibir confirma√ß√£o:
       - ""Tem certeza que deseja excluir este lote?""
     - Se o backend retornar o erro `BATCH_HAS_REGISTRATIONS`:
       - Mostrar mensagem amig√°vel:
         - ""Esse lote j√° possui inscri√ß√µes e n√£o pode ser exclu√≠do. Considere apenas fech√°-lo ou desativ√°-lo.""


Parte 2 ‚Äì Status do evento: expirado, publicado e rela√ß√£o com lotes
-------------------------------------------------------------------

Hoje:

- A tela do cliente marca o evento como ""expirado"" quando n√£o h√° lote v√°lido (sem lote active).
- Isso est√° correto como prote√ß√£o.
- Por√©m:
  - Quando um lote volta a ser ativado no admin, o evento N√ÉO tem seu status ajustado.
  - Publicar o evento manualmente n√£o funciona bem, pois:
    - Se n√£o houver nenhum lote `active`, o evento √© marcado como expirado novamente automaticamente.

O que quero:

1. Adicionar e usar corretamente o `status` do evento, com valores como:
   - 'draft'     (rascunho)
   - 'published' (publicado e vis√≠vel)
   - 'expired'   (expirado/sem lote v√°lido ou encerrado)
   - 'closed'    (encerrado manualmente ap√≥s a realiza√ß√£o do evento, por exemplo)

2. Regras entre evento e lotes:

   - Se o evento estiver `published`:
     - mas N√ÉO houver nenhum lote com `status = 'active'`:
       - a tela do cliente deve mostrar o evento como ""inscri√ß√µes encerradas"" ou similar (expirado do ponto de vista de inscri√ß√£o)
       - MAS isso n√£o deve alterar o `status` administrativo automaticamente para 'expired' sem crit√©rio.

   - Se a l√≥gica atual estiver alterando o `status` do evento para 'expired' SOMENTE com base nos lotes:
     - Revisar isso.
     - Idealmente:
       - Use um campo separado para ""inscri√ß√µes dispon√≠veis"" vs ""publica√ß√£o do evento"".
       - Ou ent√£o:
         - mantenha `published` como ""vis√≠vel""
         - e controle o fluxo de inscri√ß√£o pela exist√™ncia ou n√£o de lote active.

3. Ao ativar um lote em um evento que est√° `expired`:

   - N√ÉO quero que o evento seja publicado automaticamente.
   - Quero um fluxo assim:

     - Admin ativa um lote em evento com status 'expired':
       - backend detecta essa situa√ß√£o
       - o frontend mostra um di√°logo:
         - ""Voc√™ ativou um lote em um evento expirado. Deseja publicar o evento para reabrir as inscri√ß√µes?""
       - Se o admin confirmar:
         - atualizar `event.status = 'published'`
       - Se o admin recusar:
         - evento continua expirado, e o lote ativo n√£o deve ser usado no frontend de inscri√ß√£o.

   - Ou seja:
     - O evento s√≥ deve voltar a ser ""publicado"" se o admin conscientemente escolher isso.

4. Fluxo de publica√ß√£o:

   - Ajustar o comportamento do bot√£o ""Publicar evento"":
     - Ao publicar:
       - verificar se existe pelo menos um lote `status = 'active'`.
       - Se n√£o existir:
         - dar alerta:
           - ""Este evento n√£o possui nenhum lote ativo. Ele ser√° publicado, mas as inscri√ß√µes aparecer√£o como indispon√≠veis at√© que um lote seja ativado.""
         - ou, se preferir:
           - bloquear publica√ß√£o sem lote active, exigindo um lote active.


Parte 3 ‚Äì Integra√ß√£o com a tela do cliente
------------------------------------------
Na tela de evento do cliente (frontend):

1. Se `event.status` ‚â† 'published':
   - N√£o permitir fluxo de inscri√ß√£o
   - Mostrar status de acordo (rascunho, fechado, etc.)

2. Se `event.status = 'published'`:
   - Checar lotes:
     - Se houver lote `status = 'active'`:
       - permitir inscri√ß√µes
       - exibir valor e info corretas
     - Se N√ÉO houver lote `status = 'active'`:
       - mostrar ""inscri√ß√µes encerradas"", ""esgotado"" ou ""breve"" de acordo com a regra
       - importante: N√ÉO transformar modalidades pagas em gratuitas em nenhum caso.

Objetivo final deste prompt
---------------------------
Depois dessas mudan√ßas:

- A exclus√£o de lote funciona, mas √© segura (n√£o apaga lotes usados).
- O status do evento n√£o fica ""oscilando"" automaticamente de forma incoerente.
- Ativar lote em evento expirado oferece op√ß√£o de publicar o evento via confirma√ß√£o.
- O frontend do cliente respeita:
  - status do evento
  - status dos lotes
  - sem permitir inscri√ß√µes em estados ilegais.
"