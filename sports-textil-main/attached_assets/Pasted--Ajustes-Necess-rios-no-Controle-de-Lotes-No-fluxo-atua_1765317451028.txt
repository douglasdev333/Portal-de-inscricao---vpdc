üìå Ajustes Necess√°rios no Controle de Lotes

No fluxo atual, ao atingir o limite de vagas do lote ativo, o sistema est√° fechando corretamente o lote, por√©m n√£o est√° ativando o pr√≥ximo lote automaticamente, deixando o sistema sem lote ativo e impossibilitando novas inscri√ß√µes.

Al√©m disso:

Existe a possibilidade de ativar mais de um lote ao mesmo tempo, o que n√£o pode ocorrer.

A coluna modality_id existe na tabela de lotes, por√©m o fluxo real n√£o utiliza lotes espec√≠ficos por modalidade ‚Äî os lotes s√£o globais por evento.
‚ûù Se n√£o houver nenhum uso funcional dessa coluna, ela deve ser removida.

Abaixo seguem as instru√ß√µes exatas para corrigir:

üéØ Corre√ß√µes solicitadas
1. Garantir que exista sempre um √∫nico lote ativo por evento

Regras obrigat√≥rias:

Um evento s√≥ pode ter exatamente 1 lote ativo ao mesmo tempo.

A interface de cria√ß√£o e edi√ß√£o de evento/lotes deve impedir o status active para mais de um lote.

Caso o administrador tente ativar outro lote, o sistema deve:

desativar/fechar o anterior,

ou bloquear a ativa√ß√£o com mensagem apropriada.

Tecnicamente:

Criar valida√ß√£o:

SELECT COUNT(*) FROM event_lots WHERE event_id = :eventId AND status = 'active'


Se > 1 ‚Üí inconsist√™ncia

Se durante update:
‚Üí impedir altera√ß√£o inv√°lida

2. Implementar a virada autom√°tica de lote dentro da transa√ß√£o at√¥mica

Na transa√ß√£o de inscri√ß√£o:

Quando o lote ativo estiver cheio (vagas_ocupadas >= capacity):

O que fazer agora:

Atualizar o lote atual:

UPDATE event_lots
SET status = 'closed'
WHERE id = :currentLotId;


Buscar o pr√≥ximo lote com base em order_index:

SELECT id
FROM event_lots
WHERE event_id = :eventId
  AND status IN ('future')
ORDER BY order_index
LIMIT 1
FOR UPDATE;


Se existir, ativar:

UPDATE event_lots
SET status = 'active'
WHERE id = :nextLotId;


A inscri√ß√£o deve ser conclu√≠da apenas se o novo lote tiver vagas_ocupadas < capacity.

Caso N√ÉO exista pr√≥ximo lote:
‚Üí retornar msg amig√°vel:

LOTE_ESGOTADO_E_SEM_PROXIMO

3. Determinar como o sistema sabe qual √© o pr√≥ximo lote

A defini√ß√£o deve vir de uma coluna de ordena√ß√£o:

‚úî Campo recomendado j√° existente: order_index

Regra:

order_index ASC define a ordem natural dos lotes.

O primeiro order_index que estiver com status future √© o correto a ser ativado.

Exemplo:

order_index	status
1	closed
2	active
3	future
4	future

Quando o lote 2 encher ‚Üí lote 3 vira active

4. Ajustar l√≥gica da tela de cria√ß√£o/edi√ß√£o de eventos/lotes

Regras na interface:

Bloquear ativa√ß√£o manual de dois lotes.

Caso usu√°rio selecione um novo lote como ativo:

automaticamente fechar ou desativar o que estiver ativo.

Exibir alerta claro:

"Somente um lote pode estar ativo ao mesmo tempo no mesmo evento."

üéØ Sobre a coluna modality_id em event_lots

Atualmente a coluna existe, por√©m:

Os lotes est√£o funcionando para o evento inteiro, n√£o por modalidade.

O sistema de neg√≥cio que estamos adotando n√£o exige lote por modalidade.

Portanto:

‚úî Se N√ÉO houver regra expl√≠cita associando lotes a modalidades:
üëâ remover a coluna modality_id

Ou

‚úî Caso seja necess√°rio futuramente (n√£o agora):
üëâ manter mas deixar documentado como n√£o aplic√°vel no fluxo de inscri√ß√£o atual.

üß© Regras finais atualizadas

Evento:

Quando atingir o limite global ‚Üí trava tudo.

Modalidade (se houver limite):

Travar s√≥ essa modalidade.

Lote:

Somente um ativo por evento

Quando encher:

fecha esse lote

ativa o pr√≥ximo (order_index ASC)

Se n√£o houver pr√≥ximo lote:
‚Üí inscri√ß√µes nessa modalidade/evento s√£o encerradas

üí° O que o LLM deve entregar

Ajustes no backend:

lock adequado e virada autom√°tica do lote

valida√ß√£o de lote √∫nico ativo

retorno de erros espec√≠ficos

Ajustes no front/admin:

impedir m√∫ltiplos lotes ativos

ordem transparente dos lotes

Ajustes no banco:

opcional: remover coluna modality_id

Atualiza√ß√£o da documenta√ß√£o gerando fluxograma atualizado:

Event Full? ‚Üí bloqueia tudo
else
   Modality Full? ‚Üí bloqueia modalidade
   else
      Lot Full? ‚Üí fechar lote ‚Üí ativar pr√≥ximo ‚Üí tentar de novo
