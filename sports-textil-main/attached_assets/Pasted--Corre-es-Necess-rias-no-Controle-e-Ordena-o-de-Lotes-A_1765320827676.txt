üö® Corre√ß√µes Necess√°rias no Controle e Ordena√ß√£o de Lotes

Ap√≥s as atualiza√ß√µes entregues, ainda existem comportamentos incorretos relacionados aos lotes.
Preciso que a l√≥gica seja revisada e corrigida prioritariamente nos seguintes pontos:

‚ùó PROBLEMA 1 ‚Äî Todos os lotes est√£o com order_index = 1

Hoje quando criamos ou editamos lotes, o campo order_index est√° sendo atribu√≠do sempre com valor 1, e o admin n√£o tem op√ß√£o de editar sua ordem.

Isso impede:

ativa√ß√£o correta do pr√≥ximo lote

fechamento autom√°tico com transi√ß√£o v√°lida

ordena√ß√£o confi√°vel

‚úÖ O que deve ser corrigido
1. Durante a cria√ß√£o de lote:

Se o admin n√£o informar manualmente a ordem, o sistema deve atribuir automaticamente o pr√≥ximo √≠ndice sequencial:

Exemplo:

Se os lotes existentes possuem:

id	order_index
5	1
6	2

Ent√£o no pr√≥ximo lote criado:

‚Üí order_index = 3 automaticamente

SQL sugerido:

SELECT COALESCE(MAX(order_index), 0) + 1
FROM registration_batches
WHERE event_id = :eventId;

2. Na edi√ß√£o de lote

O sistema deve permitir que o admin altere order_index.

Regras obrigat√≥rias:

N√£o pode existir mais de um lote com o mesmo order_index

Altera√ß√µes devem ser validadas antes de salvar

Ao editar:

Se algu√©m tentar colocar order_index j√° existente:

‚Üí retornar erro amig√°vel:

ORDER_INDEX_ALREADY_EXISTS
"J√° existe um lote usando essa ordem. Altere a ordem dos demais ou utilize outro n√∫mero."

‚ùó PROBLEMA 2 ‚Äî Admin n√£o consegue ordenar lotes visualmente

Preciso que:

No painel admin:

A listagem dos lotes seja exibida ordenada por order_index ASC

Haja campo vis√≠vel de edi√ß√£o do campo order_index

Ao alterar um lote:

o sistema deve persistir corretamente o valor

validar duplicidade conforme regra acima

‚ùó PROBLEMA 3 ‚Äî Pr√≥ximo lote n√£o est√° sendo ativado quando necess√°rio

Hoje o lote fecha, mas n√£o existe identifica√ß√£o clara do pr√≥ximo lote.

Isso acontece porque:

sem order_index v√°lido, a query de pr√≥ximo lote n√£o funciona

os lotes ficam com o mesmo √≠ndice, logo n√£o h√° pr√≥ximo

Revisar a l√≥gica de ativa√ß√£o com base obrigat√≥ria em order_index

Ap√≥s fechamento do lote atual:

buscar:

SELECT id
FROM registration_batches
WHERE event_id = :eventId
  AND status = 'future'
  AND order_index > currentOrder
ORDER BY order_index ASC
LIMIT 1;


Se retornar resultado ‚Üí ativar lote

Se n√£o retornar resultado ‚Üí
‚Üí LOT_ESGOTADO_SEM_PROXIMO

‚ùó PROBLEMA 4 ‚Äî Testar lote expirando por data com fuso hor√°rio

Hoje a l√≥gica de expira√ß√£o est√° avaliando datas usando UTC (3h √† frente do Brasil).

Quando for validar data de in√≠cio ou t√©rmino do lote, precisa considerar:

Regra correta

Hora base deve ser:

NOW() AT TIME ZONE 'America/Sao_Paulo'


‚Äî

Exemplo de query correta:

SELECT *
FROM registration_batches
WHERE event_id = :eventId
  AND status = 'active'
  AND (
    expiration_at IS NULL
    OR expiration_at <= (NOW() AT TIME ZONE 'America/Sao_Paulo')
  )

‚ùó Solicita√ß√£o adicional: Criar um evento de teste e resetar banco

Pe√ßo que:

üßπ Limpe as seguintes tabelas:

events

registrations

registration_batches

event_modalities (se existir)

qualquer tabela auxiliar relacionada

‚ùó IMPORTANTE:
‚û°Ô∏è N√£o excluir registros da tabela de administradores

üß™ Criar automaticamente este conjunto de dados de teste:
Evento
Evento Teste Transi√ß√£o de Lotes
capacity = 250

Lotes
nome	order_index	capacity	price_cents	status
Lote 1	1	50	10000	active
Lote 2	2	100	12000	future
Lote 3	3	100	14000	future
Cen√°rio esperado:

Ao simular 50 inscri√ß√µes ‚Üí lote 1 deve fechar e lote 2 deve ativar

Ao simular +100 ‚Üí lote 2 fecha e lote 3 ativa

Ao simular +100 ‚Üí lote 3 esgota e retorna LOT_ESGOTADO_SEM_PROXIMO

üß† Em resumo, o que deve sair desta revis√£o:

‚úî order_index calculado automaticamente
‚úî admin pode alterar order_index manualmente
‚úî valida√ß√£o que evita duplicidade de ordem
‚úî migra√ß√£o segura do lote ativo para pr√≥ximo lote
‚úî expira√ß√£o usando hor√°rio de S√£o Paulo
‚úî cria√ß√£o de evento e lotes de teste
‚úî limpeza seletiva do banco antes do teste

üëâ Execute a revis√£o com prioridade nessas corre√ß√µes.